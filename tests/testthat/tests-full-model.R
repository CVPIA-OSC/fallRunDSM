library(fallRunDSM)
library(testthat)

# adds full model test (only tests spawners output)

# Stochastic full model test ---------------------------------------------------
run_model <- function() {
  set.seed(2021)
  seeded_adults <- fall_run_model()
  output <- fall_run_model(seeds = seeded_adults,
                           mode = "simulate",
                           stochastic = TRUE)
  return(output)
}
expected_model_output <- list(spawners = structure(c(61063, 407, 40528, 313, 318, 1683,
                                                     13441, 6878, 2746, 1273, 301, 1078, 437, 322, 322, 0, 0, 312,
                                                     186989, 31516, 0, 0, 31427, 0, 411, 1621, 8309, 3991, 5692, 1648,
                                                     0, 76858, 418, 61719, 339, 331, 1940, 14333, 8383, 3562, 1568,
                                                     386, 1296, 476, 373, 344, 0, 0, 351, 271099, 45619, 0, 0, 46863,
                                                     0, 428, 1840, 12447, 6240, 9043, 2524, 0, 41061, 328, 40247,
                                                     250, 242, 1171, 7313, 4756, 2007, 871, 262, 716, 284, 271, 259,
                                                     0, 0, 283, 170566, 32051, 0, 0, 31134, 0, 380, 1554, 8566, 4852,
                                                     8015, 1967, 0, 31687, 257, 51830, 174, 182, 673, 5584, 4002,
                                                     1468, 663, 203, 475, 217, 204, 178, 0, 0, 238, 183411, 36638,
                                                     0, 0, 39806, 0, 317, 1561, 11436, 6113, 8108, 2231, 0, 31235,
                                                     413, 26709, 318, 302, 1053, 5682, 4712, 975, 723, 543, 522, 342,
                                                     435, 360, 0, 0, 389, 116600, 31163, 0, 0, 24989, 0, 1036, 1804,
                                                     7713, 3161, 4564, 1283, 0, 66948, 717, 64236, 579, 607, 2113,
                                                     11771, 10427, 1998, 1497, 1068, 932, 631, 822, 800, 0, 0, 819,
                                                     285221, 68314, 0, 0, 52622, 0, 2092, 3486, 17636, 6669, 9104,
                                                     2717, 0, 60571, 764, 57376, 638, 612, 1707, 10691, 10078, 2270,
                                                     1432, 1015, 793, 668, 850, 695, 0, 0, 922, 267355, 62249, 0,
                                                     0, 45418, 0, 1903, 4175, 16143, 6165, 8425, 2555, 0, 29628, 420,
                                                     32964, 411, 416, 969, 5371, 5680, 1557, 773, 618, 452, 378, 545,
                                                     502, 0, 0, 473, 150352, 32694, 0, 0, 26877, 0, 1393, 2581, 8381,
                                                     3745, 5339, 1479, 0, 28650, 297, 47168, 259, 314, 1246, 5099,
                                                     4976, 1502, 764, 661, 504, 288, 506, 555, 0, 0, 327, 170841,
                                                     33204, 0, 0, 38409, 0, 2053, 1707, 9701, 5662, 5740, 1819, 0,
                                                     28710, 269, 42317, 197, 207, 1425, 4946, 4608, 1425, 656, 802,
                                                     344, 257, 393, 621, 0, 0, 311, 149816, 30914, 0, 0, 36006, 0,
                                                     1975, 1897, 8338, 5958, 4523, 1553, 0, 26542, 180, 47236, 125,
                                                     144, 835, 4385, 3729, 1101, 516, 445, 318, 181, 210, 349, 0,
                                                     0, 193, 166246, 30077, 0, 0, 36961, 0, 991, 1050, 9200, 5478,
                                                     4883, 1689, 0, 9794, 61, 15086, 83, 74, 251, 1478, 1275, 353,
                                                     185, 83, 158, 65, 135, 131, 0, 0, 75, 62326, 10416, 0, 0, 14154,
                                                     0, 522, 187, 3045, 1452, 1551, 541, 0, 30169, 146, 58777, 158,
                                                     150, 580, 4715, 4096, 1150, 564, 157, 386, 128, 168, 234, 0,
                                                     0, 133, 210300, 34340, 0, 0, 45158, 0, 628, 271, 11679, 5631,
                                                     6114, 2073, 0, 7457, 56, 11440, 56, 69, 193, 1161, 1051, 286,
                                                     149, 70, 109, 60, 88, 120, 0, 0, 69, 45364, 7666, 0, 0, 11505,
                                                     0, 617, 123, 2353, 1095, 1197, 420, 0, 22657, 81, 45173, 64,
                                                     73, 272, 3567, 2487, 941, 347, 93, 220, 82, 76, 72, 0, 0, 92,
                                                     155954, 25181, 0, 0, 33145, 0, 702, 107, 8871, 4441, 4613, 1545,
                                                     0, 32559, 150, 54341, 117, 133, 335, 5456, 3462, 1103, 505, 135,
                                                     332, 109, 135, 132, 0, 0, 130, 187860, 31454, 0, 0, 39733, 0,
                                                     609, 124, 10661, 5062, 5651, 1908, 0, 19354, 123, 17192, 83,
                                                     96, 194, 3335, 1554, 447, 224, 134, 139, 95, 122, 104, 0, 0,
                                                     128, 61908, 12538, 0, 0, 14079, 0, 425, 108, 3337, 1730, 1787,
                                                     648, 0, 33904, 204, 55838, 131, 148, 411, 5669, 4132, 1436, 568,
                                                     170, 340, 160, 145, 135, 0, 0, 139, 192475, 33664, 0, 0, 40363,
                                                     0, 456, 137, 10973, 5452, 5818, 1908, 0, 27430, 286, 34818, 201,
                                                     246, 379, 4364, 3653, 1477, 467, 235, 366, 216, 225, 272, 0,
                                                     0, 263, 148924, 29634, 0, 0, 27162, 0, 305, 186, 7130, 3489,
                                                     3829, 1330, 0, 36847, 325, 55804, 289, 301, 577, 5271, 4828,
                                                     1753, 686, 322, 496, 287, 371, 324, 0, 0, 454, 235829, 48097,
                                                     0, 0, 42572, 0, 822, 286, 10820, 5690, 6508, 2092, 0), .Dim = c(31L,
                                                                                                                     20L), .Dimnames = list(c("Upper Sacramento River", "Antelope Creek",
                                                                                                                                              "Battle Creek", "Bear Creek", "Big Chico Creek", "Butte Creek",
                                                                                                                                              "Clear Creek", "Cottonwood Creek", "Cow Creek", "Deer Creek",
                                                                                                                                              "Elder Creek", "Mill Creek", "Paynes Creek", "Stony Creek", "Thomes Creek",
                                                                                                                                              "Upper-mid Sacramento River", "Sutter Bypass", "Bear River",
                                                                                                                                              "Feather River", "Yuba River", "Lower-mid Sacramento River",
                                                                                                                                              "Yolo Bypass", "American River", "Lower Sacramento River", "Calaveras River",
                                                                                                                                              "Cosumnes River", "Mokelumne River", "Merced River", "Stanislaus River",
                                                                                                                                              "Tuolumne River", "San Joaquin River"), c("1", "2", "3", "4",
                                                                                                                                                                                        "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15",
                                                                                                                                                                                        "16", "17", "18", "19", "20"))))

test_that("The full model results remain the same (with a set seed)", {
  expect_equal(run_model()[1], expected_model_output)
})

# Deterministic Full Model Test ------------------------------------------------
run_model_det <- function() {
  seeded_adults <- fall_run_model()
  output <- fall_run_model(seeds = seeded_adults,
                           mode = "simulate",
                           stochastic = FALSE)
  return(output)
}
expected_model_output_det <- list(spawners = structure(c(60474, 366, 38796, 303, 305, 1691,
                                                         13377, 6770, 2711, 1245, 315, 1064, 400, 308, 306, 0, 0, 303,
                                                         181389, 30602, 0, 0, 30671, 0, 363, 1615, 7882, 3917, 5549, 1590,
                                                         0, 66570, 419, 38791, 328, 332, 1824, 12802, 7042, 3180, 1389,
                                                         345, 1172, 424, 332, 331, 0, 0, 334, 195180, 33257, 0, 0, 31272,
                                                         0, 390, 1807, 7914, 4132, 6819, 1753, 0, 39987, 304, 38558, 251,
                                                         251, 1106, 7120, 4753, 1965, 876, 272, 719, 299, 258, 252, 0,
                                                         0, 291, 165627, 31790, 0, 0, 30381, 0, 508, 1503, 7838, 4598,
                                                         7912, 1872, 0, 23990, 182, 38421, 155, 149, 542, 4405, 3197,
                                                         1102, 514, 195, 373, 185, 169, 160, 0, 0, 222, 138853, 30251,
                                                         0, 0, 29990, 0, 604, 1354, 7771, 4804, 6868, 1751, 0, 34797,
                                                         313, 38503, 308, 277, 947, 6112, 5854, 1523, 816, 489, 481, 362,
                                                         411, 381, 0, 0, 386, 151199, 32889, 0, 0, 30786, 0, 963, 2091,
                                                         7905, 4257, 6220, 1584, 0, 62875, 679, 38732, 682, 592, 1815,
                                                         9904, 12272, 2631, 1495, 1133, 801, 782, 872, 808, 0, 0, 817,
                                                         200613, 46837, 0, 0, 33300, 0, 2026, 4254, 8329, 4179, 6520,
                                                         1716, 0, 67655, 825, 38786, 793, 704, 1761, 9566, 13148, 2820,
                                                         1579, 1288, 877, 892, 951, 891, 0, 0, 996, 219427, 52364, 0,
                                                         0, 33886, 0, 2236, 4852, 8434, 4816, 7739, 2032, 0, 39945, 441,
                                                         38551, 396, 375, 961, 5621, 7070, 1611, 876, 676, 507, 455, 537,
                                                         503, 0, 0, 567, 179163, 37356, 0, 0, 31447, 0, 1000, 2819, 7960,
                                                         4733, 8073, 1916, 0, 26948, 272, 38426, 232, 271, 921, 4116,
                                                         3960, 1032, 607, 543, 353, 282, 373, 498, 0, 0, 300, 142787,
                                                         27343, 0, 0, 30323, 0, 902, 1783, 7646, 4119, 5770, 1583, 0,
                                                         29018, 272, 38427, 236, 295, 1144, 4207, 4169, 1053, 606, 686,
                                                         338, 284, 339, 629, 0, 0, 274, 137554, 27037, 0, 0, 30695, 0,
                                                         1420, 1816, 7576, 3801, 4043, 1394, 0, 24457, 186, 38400, 155,
                                                         186, 689, 3658, 3241, 907, 465, 386, 275, 186, 216, 358, 0, 0,
                                                         176, 136692, 24904, 0, 0, 30045, 0, 812, 992, 7559, 3731, 4016,
                                                         1367, 0, 22212, 136, 38399, 109, 122, 322, 3482, 2723, 829, 401,
                                                         171, 245, 129, 145, 197, 0, 0, 92, 138081, 22824, 0, 0, 30254,
                                                         0, 381, 316, 7549, 3675, 4001, 1352, 0, 23796, 157, 38425, 131,
                                                         149, 379, 3753, 3050, 869, 434, 226, 266, 153, 167, 282, 0, 0,
                                                         112, 139246, 22699, 0, 0, 30843, 0, 585, 281, 7561, 3688, 4020,
                                                         1371, 0, 20880, 110, 38396, 92, 107, 298, 3301, 2633, 807, 372,
                                                         141, 225, 109, 108, 171, 0, 0, 82, 134661, 21960, 0, 0, 30380,
                                                         0, 384, 185, 7544, 3682, 3993, 1344, 0, 18104, 78, 38376, 68,
                                                         78, 239, 2889, 2255, 758, 330, 73, 199, 78, 70, 76, 0, 0, 68,
                                                         132790, 21417, 0, 0, 30312, 0, 148, 156, 7539, 3687, 3981, 1332,
                                                         0, 27136, 197, 38526, 174, 162, 439, 4479, 5381, 1261, 552, 307,
                                                         292, 197, 201, 241, 0, 0, 140, 144462, 24333, 0, 0, 31034, 0,
                                                         177, 203, 7574, 3718, 4147, 1390, 0, 36976, 310, 38673, 274,
                                                         242, 632, 6146, 8501, 1757, 778, 539, 383, 311, 333, 408, 0,
                                                         0, 204, 152552, 26950, 0, 0, 31270, 0, 226, 266, 7606, 3747,
                                                         4308, 1445, 0, 37478, 388, 38758, 339, 399, 726, 6161, 9212,
                                                         1946, 942, 797, 464, 388, 424, 468, 0, 0, 241, 144400, 31653,
                                                         0, 0, 31680, 0, 300, 337, 7607, 3748, 4361, 1446, 0, 41425, 562,
                                                         38895, 504, 648, 961, 6706, 11546, 2310, 1227, 1288, 637, 569,
                                                         674, 700, 0, 0, 426, 154500, 41467, 0, 0, 33282, 0, 531, 488,
                                                         7657, 3821, 4728, 1525, 0, 37824, 474, 38712, 431, 497, 807,
                                                         5866, 9411, 1809, 973, 1038, 555, 476, 618, 644, 0, 0, 479, 169050,
                                                         40717, 0, 0, 32742, 0, 619, 457, 7701, 4111, 5370, 1616, 0),
                                                       .Dim = c(31L, 20L),
                                                       .Dimnames = list(c("Upper Sacramento River", "Antelope Creek",
                                                                          "Battle Creek", "Bear Creek", "Big Chico Creek", "Butte Creek",
                                                                          "Clear Creek", "Cottonwood Creek", "Cow Creek", "Deer Creek",
                                                                          "Elder Creek", "Mill Creek", "Paynes Creek", "Stony Creek", "Thomes Creek",
                                                                          "Upper-mid Sacramento River", "Sutter Bypass", "Bear River",
                                                                          "Feather River", "Yuba River", "Lower-mid Sacramento River",
                                                                          "Yolo Bypass", "American River", "Lower Sacramento River", "Calaveras River",
                                                                          "Cosumnes River", "Mokelumne River", "Merced River", "Stanislaus River",
                                                                          "Tuolumne River", "San Joaquin River"), c("1", "2", "3", "4",
                                                                                                                    "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15",
                                                                                                                    "16", "17", "18", "19", "20"))))

test_that("The full model results remain the same when run deterministic", {
  expect_equal(run_model_det()[1], expected_model_output_det)
})
