---
title: "DSM Logistic Temperature Model Documenation"
output: 
  html_document:
    theme: flatly
    code_folding: hide
vignette: >
  %\VignetteIndexEntry{temperature-model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
library(readr)
library(tidyverse)
library(boot)
library(formattable)
library(DT)
```
## Chinook supplementary analysis for Chinook DSM models

### Central Valley river and Delta logistic temperature models 

The script below analyzes the relationship between monthly median temperature and temperature exceedance variables. In this script we use logistic regression to be able to predict if temperatures exceed 20 degrees or 25 degrees in a month based on a medium monthly value. 

The logistic regression coefficients are used to define the `aveT20` and `maxT25` in the survival submodels of the `fallRunDSM`, `springRunDSM`, and `winterRunDSM` models. 

#### Data Source
This analysis is done using data from the [Full temperature data.csv](https://dsm-docs.s3-us-west-2.amazonaws.com/temperature_modeling/Full+temperature+data.csv). TODO where is the "Full temperature data.csv" coming from?

The table below shows the temperature grouped by month and year and summarized to give monthly mean temperature, proportion of days over 20 degrees, and the count of days per month over 25 degrees. 
```{r}
full_temp_data <- read_csv(system.file("extdata", "temperature-data", "Full temperature data.csv", 
                       package = "fallRunDSM", mustWork = TRUE)) %>% 
  na.omit() %>%
  mutate(gt20 = ifelse(medC > 20, 1, 0),
         gt25 = ifelse(maxC > 20, 1, 0))

#summary(full_temp_data)
#sum(full_temp_data$gt25)

grouped_temp_measures <- full_temp_data %>%
  group_by(year, month) %>%
  summarise(count_measures_gt_25 = sum(gt25),
            prop_gt_20 = mean(gt20),
            month_mean_temp = mean(medC)) 
datatable(grouped_temp_measures %>% rename("Year" = year, 
                                           "Month" = month,
                                           "Number of Measures Exceeding 25 degrees" = count_measures_gt_25,
                                           "Proportion Exceeding 20" = prop_gt_20,
                                           "Monthly Mean Temp" = month_mean_temp),
          options = list(
                    searching = FALSE,
                    pageLength = 5,
                    lengthMenu = c(5, 10, 15, 20)
))
```

### Logistic Regression model 

Model proportion month with temps > 20 C using logistic regression. To allow for logistic regression model use we adjusted zeros to .001 of and 1's to .999. 
We appended an additional column to our data containing the odds ratio by taking takes log(Proportion Exceeding 20/(1 - Proportion Exceeding 20)). 

We find the linear relationship between the odds ratio and the mean monthly temperature and use the estimates generated for the Intercept and Monthly Mean temp as inputs to a logistic model prediction. 
```{r}
grouped_temp_measures_for_logistic <- grouped_temp_measures %>%
  mutate(prop_gt_20 = case_when(prop_gt_20 == 0 ~ 0.001, 
                                 prop_gt_20 == 1 ~ 0.999,
                                 prop_gt_20 != 0 & prop_gt_20 != 1 ~ prop_gt_20),
         odds_ratio = log(prop_gt_20 / (1 - prop_gt_20)))

#summary(grouped_temp_measures_for_logistic)
lm_summary <- summary(lm(odds_ratio ~ month_mean_temp, data = grouped_temp_measures_for_logistic))

month_means <- c(5:25) # ? where does this come from?
prediction <- boot::inv.logit(lm_summary$coefficients[1, 1] + lm_summary$coefficients[2, 1] * month_means)
monthly_predictions <- data.frame(month_means, prediction)
```

#### Graph logistic model of proportion days temperature exceedes 20 in a month and monthly mean temp
The graph below shows a scatterplot of mean monthly temperature and the proportion of measures greater than 20 degrees. The red line is our logistic model prediction.

Logistic Model Input: Proportions above 20 (input to logistic model to find `avgT20` in DSM models). 

Here we define the numeric input to logistic model based on the coefficients generated by fitting a linear model on the `odds_ratio` and `month_mean_temp`. We take the sum of our linear model intercept and slope and multiply this by the month mean temperature to find the numeric input for our logistic model:

* Numeric Input = `r lm_summary$coefficients[1, 1]` + `r lm_summary$coefficients[2, 1]` * `month mean temperature`

Graphing the proportions greater than 20 and a prediction line calculated by taking the logistic regression based on the numeric input defined above (`boot::inv.logit(Numeric Input)`) we generate the following plot:

```{r}
monthly_predictions %>%
  ggplot() +
  geom_line(aes(month_means, prediction), color = "Red") +
  geom_point(data = grouped_temp_measures_for_logistic, aes(x = month_mean_temp, y = prop_gt_20)) +
  xlab("Monthly mean temperature") +
  ylab("Proportion days temp > 20 in a month")
```



```{r}
grouped_temp_measures_for_logistic <- grouped_temp_measures %>%
  mutate(count_measures_gt_25 = ifelse(count_measures_gt_25 > 1, 1, count_measures_gt_25))

glm_summary <- summary(glm(count_measures_gt_25 ~ month_mean_temp, data=grouped_temp_measures_for_logistic, family='binomial'))

month_means <- c(5:25) # ? where does this come from?
prediction <- boot::inv.logit(glm_summary$coefficients[1, 1] + glm_summary$coefficients[2, 1] * month_means)
monthly_predictions <- data.frame(month_means, prediction)

```

#### Graph temp exceeding 25 during month and mean monthly temperture 

Max above 25 (input to logistic model to find `maxT25` in DSM models) Here we define the numeric input to logistic model based on the coefficients generated by fitting a generalized linear model on the `count_gt_25` and `month_mean_temp`. We take the sum of our linear model intercept and slope and multiply this by the month mean temperature to find the numeric input for our logistic model: 

* Numeric Input = `r glm_summary$coefficients[1, 1]` + `r glm_summary$coefficients[2, 1]` * `month mean temperature`

Graphing temperature exceedence of 25 and a prediction line calculated by taking the logistic regression based on the numeric input defined above (`boot::inv.logit(Numeric Input)`) we generate the following plot:
```{r}
monthly_predictions %>%
  ggplot() +
  geom_line(aes(month_means, prediction), color = "Red") +
  geom_point(data = grouped_temp_measures_for_logistic, aes(x = month_mean_temp, y = count_measures_gt_25)) +
  xlab("Monthly mean temperature") +
  ylab("Temp goes above 25 during month")

```





