---
title: "DSM Logistic Temperature Model Documenation"
output: 
  html_document:
    theme: flatly
    code_folding: hide
vignette: >
  %\VignetteIndexEntry{temperature-model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.width=15, fig.height=8)
library(readr)
library(tidyverse)
library(boot) # Used for logit/inv.logit calculation
library(DT)
library(gridExtra)
```

## Chinook supplementary analysis for Chinook DSM models

### Logistic models to estimate temperature metrics 

The script below analyzes the relationship between monthly median temperature and temperature exceedance variables. In this script we use logistic regression to be able to predict if temperatures exceed 20 degrees or 25 degrees in a month based on a medium monthly value. 

The logistic regression coefficients are used to define the `aveT20` and `maxT25` in the `get_rearing_survival()` submodel of `fallRunDSM`. 

#### Data Sources

Central Valley River Temps: 
This analysis is done using data from the [Full temperature data.csv](https://dsm-docs.s3-us-west-2.amazonaws.com/temperature_modeling/Full+temperature+data.csv). 

Delta Temps:
This analysis is done using the following data:

* [DUTCH SLOUGH.csv](https://dsm-docs.s3-us-west-2.amazonaws.com/temperature_modeling/DUTCH+SLOUGH.csv)
* [GEORGIANA SLOUGH.csv](https://dsm-docs.s3-us-west-2.amazonaws.com/temperature_modeling/GEORGIANA+SLOUGH.csv)
* [JERSEY POINT.csv](https://dsm-docs.s3-us-west-2.amazonaws.com/temperature_modeling/JERSEY+POINT.csv)
* [LPotatoSLough.csv](https://dsm-docs.s3-us-west-2.amazonaws.com/temperature_modeling/LPotatoSlough.csv)

TODO source for these CSVs?

#### Temperature Data 
The table below shows the Central Valley and delta temperature grouped by month and year and summarized to give monthly mean temperature, proportion of days over 20 degrees, and the count of days per month over 25 degrees. 
```{r}
full_temp_data <- read_csv(system.file("extdata", "temperature-data", "Full temperature data.csv", 
                           package = "fallRunDSM", mustWork = TRUE)) %>% 
  na.omit() %>%
  mutate(gt20 = ifelse(medC > 20, 1, 0),
         gt25 = ifelse(maxC > 20, 1, 0))

grouped_temp_measures <- full_temp_data %>%
  group_by(year, month) %>%
  summarise(prop_gt_20 = round(mean(gt20), 2),
            count_measures_gt_25 = sum(gt25),
            month_mean_temp = round(mean(medC), 2)) 

jersey_point <- read_csv(system.file("extdata", "temperature-data", "JERSEY POINT.csv", 
                           package = "fallRunDSM", mustWork = TRUE))
dutch_slough <- read_csv(system.file("extdata", "temperature-data", "DUTCH SLOUGH.csv", 
                           package = "fallRunDSM", mustWork = TRUE))
georgiana_slough <- read_csv(system.file("extdata", "temperature-data", "GEORGIANA SLOUGH.csv", 
                           package = "fallRunDSM", mustWork = TRUE))
potato_slough <-read_csv(system.file("extdata", "temperature-data", "LPotatoSlough.csv", 
                           package = "fallRunDSM", mustWork = TRUE))

delta_full_temp_data <- rbind(jersey_point, dutch_slough, georgiana_slough, potato_slough) %>%
  na.omit() %>%
  mutate(gt20 = ifelse(TempC > 20, 1, 0),
         gt25 = ifelse(TempC > 25, 1, 0))

grouped_temp_measures_delta <- delta_full_temp_data %>%
  group_by(year, month) %>%
  summarise(delta_prop_gt_20 = round(mean(gt20), 2),
            delta_count_gt_25 = sum(gt25),
            delta_month_mean_temp = round(mean(TempC), 2))

combined_temp_measures <- grouped_temp_measures_delta %>% 
  full_join(grouped_temp_measures, by = c("month", "year"))

datatable(combined_temp_measures %>% rename("Year" = year, 
                                           "Month" = month,
                                           "CV Number of Measures Exceeding 25°C" = count_measures_gt_25,
                                           "CV Proportion Exceeding 20°C" = prop_gt_20,
                                           "CV Monthly Mean Temp" = month_mean_temp,
                                           "Delta Number of Measures Exceeding 25°C" = delta_count_gt_25,
                                           "Delta Proportion Exceeding 20°C" = delta_prop_gt_20,
                                           "Delta Monthly Mean Temp" = delta_month_mean_temp),
          options = list(
                    searching = FALSE,
                    pageLength = 5,
                    lengthMenu = c(5, 10, 15, 20)
))
```

### Logistic Regression model 

This data was prepped to model the proportion of days in a month with temps > 20 °C and if temperature will go above 25 °C using logistic regression. 

To allow for logistic regression model use we made the following edits: 

* We adjusted zeros to .001 of and 1's to .999. 
* We appended an additional column to our data containing the odds ratio by taking takes `log(Proportion Exceeding 20/(1 - Proportion Exceeding 20))`. 
* We edited our `Number of Measures Exceeding 25 degrees` to create a binary column describing when temperature exceeds 25 in a month (1) and when temperature does not exceed 25 in a month (0).

```{r}
grouped_temp_measures_for_logistic <- grouped_temp_measures %>%
  mutate(prop_gt_20 = case_when(prop_gt_20 == 0 ~ 0.001, 
                                 prop_gt_20 == 1 ~ 0.999,
                                 prop_gt_20 != 0 & prop_gt_20 != 1 ~ prop_gt_20),
         odds_ratio = log(prop_gt_20 / (1 - prop_gt_20)))

#summary(grouped_temp_measures_for_logistic)
lm_summary <- summary(lm(odds_ratio ~ month_mean_temp, data = grouped_temp_measures_for_logistic))

month_means <- c(5:25) # ? where does this come from?
prediction <- boot::inv.logit(lm_summary$coefficients[1, 1] + lm_summary$coefficients[2, 1] * month_means)
monthly_predictions <- data.frame(month_means, prediction)

# Repeat for delta 
delta_grouped_temp_measures_for_logit <- grouped_temp_measures_delta%>%
  mutate(prop_gt_20 = case_when(delta_prop_gt_20 == 0 ~ 0.001, 
                                 delta_prop_gt_20 == 1 ~ 0.999,
                                 delta_prop_gt_20 != 0 & delta_prop_gt_20 != 1 ~ delta_prop_gt_20),
         odds_ratio = log(prop_gt_20 / (1 - prop_gt_20)))

# summary(grouped_temp_measures_for_logit)
delta_lm_summary <- summary(lm(odds_ratio ~ delta_month_mean_temp, data = delta_grouped_temp_measures_for_logit))

month_means <- c(5:25) # ? where does this come from?
delta_prediction <- boot::inv.logit(lm_summary$coefficients[1, 1] + lm_summary$coefficients[2, 1] * month_means)
delta_monthly_predictions <- data.frame(month_means, delta_prediction)
```

#### Graph logistic model of proportion days temperature exceedes 20 in a month and monthly mean temp

**Finding `avgT20` in DSM models:**
In the DSM models `avgT20` is estimated for each month using a logistic model.

**Logistic Model Input:**
Here we define the numeric input to our logistic models for CV temperature and Delta temperature based on the coefficients generated by fitting a linear model on the `odds_ratio` and `month_mean_temp`. We take the sum of our linear model intercept and slope and multiply this by the month mean temperature to find the numeric input for our CV rivers and Delta logistic models:

* CV Logistic Regression Numeric Input = ``r lm_summary$coefficients[1, 1]`` + ``r lm_summary$coefficients[2, 1]`` * `month mean temperature`
* Delta Logistic Regression Numeric Input = ``r delta_lm_summary$coefficients[1, 1]`` +  ``r delta_lm_summary$coefficients[2, 1]`` * `month mean temperature`

The scatterplots below show the mean monthly temperature and the proportion of measures greater than 20 degrees for the Delta and Central Valley Rivers. The red line is our logistic model prediction based on the numeric input defined above (`boot::inv.logit(Numeric Input)`):

```{r}
cv_plot <- monthly_predictions %>%
  ggplot() +
  geom_line(aes(month_means, prediction), color = "Red") +
  geom_point(data = grouped_temp_measures_for_logistic, aes(x = month_mean_temp, y = prop_gt_20)) +
  xlab("Monthly mean temperature") +
  ylab("Proportion days temp exceeds 20°C in a month") + 
  ggtitle("Central Valley Temperature Model") +
  theme(text = element_text(size = 18))

delta_plot <- delta_monthly_predictions %>%
  ggplot() +
  geom_line(aes(month_means, prediction), color = "Red") +
  geom_point(data = delta_grouped_temp_measures_for_logit, aes(x = delta_month_mean_temp, y = delta_prop_gt_20)) +
  xlab("Monthly median temperature Delta") +
  ylab("Proportion days temp exceeds 20°C in a month") + 
  ggtitle("Delta Temperature Model") +
  theme(text = element_text(size = 18))


grid.arrange(cv_plot, delta_plot, ncol = 2)
```



```{r}
grouped_temp_measures_for_logistic <- grouped_temp_measures %>%
  mutate(count_measures_gt_25 = ifelse(count_measures_gt_25 > 1, 1, count_measures_gt_25))

glm_summary <- summary(glm(count_measures_gt_25 ~ month_mean_temp, data=grouped_temp_measures_for_logistic, family='binomial'))

month_means <- c(5:25) # ? where does this come from?
prediction <- boot::inv.logit(glm_summary$coefficients[1, 1] + glm_summary$coefficients[2, 1] * month_means)
monthly_predictions <- data.frame(month_means, prediction)

# Delta model
delta_grouped_temp_measures_for_logit <- grouped_temp_measures_delta %>%
  mutate(delta_count_gt_25 = ifelse(delta_count_gt_25 > 1, 1, delta_count_gt_25))

delta_glm_summary <- summary(glm(delta_count_gt_25 ~ delta_month_mean_temp, data = delta_grouped_temp_measures_for_logit, family='binomial'))

month_means <- c(5:25) # ? where does this come from?
delta_prediction <- boot::inv.logit(glm_summary$coefficients[1, 1] + glm_summary$coefficients[2, 1] * month_means)
delta_monthly_predictions <- data.frame(month_means, delta_prediction)
```

#### Graph temp exceeding 25 during month and mean monthly temperture 
**Finding `maxT25` in DSM models:**
In the DSM models `maxT25` is estimated for each month using a logistic model.

**Logistic model input:**
Here we define the numeric input to our logistic models for CV temperature and Delta temperature based on the coefficients generated by fitting a generalized linear model on the `count_gt_25` and `month_mean_temp`. We take the sum of our linear model intercept and slope and multiply this by the month mean temperature to find the numeric input for our CV rivers and Delta logistic models: 

* Central Valley Rivers Logistic Model Numeric Input = ``r glm_summary$coefficients[1, 1]`` + ``r glm_summary$coefficients[2, 1]`` * `month mean temperature`
* Delta Logistic Model Numeric Input = ``r delta_glm_summary$coefficients[1, 1]`` + ``r delta_glm_summary$coefficients[2, 1]`` * `month mean temperature`

The scatterplots below show if temp exceeds 25 for a given mean monthly temperature in the Delta and Central Valley Rivers. The red line is our logistic model prediction based on the numeric input defined above (`boot::inv.logit(Numeric Input)`):
```{r}
cv_plot <- monthly_predictions %>%
  ggplot() +
  geom_line(aes(month_means, prediction), color = "Red") +
  geom_point(data = grouped_temp_measures_for_logistic, aes(x = month_mean_temp, y = count_measures_gt_25)) +
  xlab("Monthly mean temperature") +
  ylab("Temp goes above 25°C during month") +
  ggtitle("Central Valley Temperature Model") +
  theme(text = element_text(size = 18))

delta_plot <- delta_monthly_predictions %>%
  ggplot() +
  geom_line(aes(month_means, prediction), color = "Red") +
  geom_point(data = delta_grouped_temp_measures_for_logit, aes(x = delta_month_mean_temp, y = delta_count_gt_25)) +
  xlab("Monthly median temperature") +
  ylab("Temp goes above 25°C during month") +
  ggtitle("Delta Temperature Model") +
  theme(text = element_text(size = 18))

grid.arrange(cv_plot, delta_plot, ncol = 2) 

```





