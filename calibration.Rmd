---
title: "Calibrating Fall Run DSM"
output: html_notebook
---

## Objective

We are using genetic algorithms, a type of stochastic optimization, to calibrate the following model coefficients:

* `..surv_adult_enroute_int` used in submodel `surv_adult_enroute`
* `..surv_adult_prespawn_int` used in submodel `surv_adult_prespawn`
* `..surv_egg_to_fry_int` used in submodel `surv_egg_to_fry`
* `..surv_juv_rear_int` used in submodel `surv_juv_rear`
* `..surv_juv_rear_contact_points` used in submodel `surv_juv_rear`
* `..surv_juv_rear_prop_diversions` used in submodel `surv_juv_rear`
* `..surv_juv_rear_total_diversions` used in submodel `surv_juv_rear`
* `..surv_juv_bypass_int` used in submodel `surv_juv_bypass`
* `..surv_juv_delta_int` used in submodel `surv_juv_delta`
* `..surv_juv_delta_contact_points` used in submodel `surv_juv_delta`
* `..surv_juv_delta_total_diverted` used in submodel `surv_juv_delta`
* `..surv_juv_outmigration_sj_int` used in submodel `surv_juv_outmigration_san_joaquin`
* `..surv_juv_outmigration_sac_int_one` used in submodel `get_migratory_survival_rates`
* `..surv_juv_outmigration_sac_prop_diversions` used in submodel `get_migratory_survival_rates`
* `..surv_juv_outmigration_sac_total_diversions` used in submodel `get_migratory_survival_rates`
* `..surv_juv_outmigration_sac_int_two` used in submodel `get_migratory_survival_rates`
* `..ocean_entry_success_int`  used in submodel `ocean_entry_success`

Each model coefficient is documented within its submodel and can be viewed using the internal R documentation. For example:

```{r, eval=FALSE}
?surv_adult_enroute
```



## Packages
```{r}
library(GA)
library(fallRunDSM)
library(DSMCalibrationData)
library(tidyverse)
```
We are using the [GA](http://luca-scr.github.io/GA/index.html) R package to implement our genetic algorithms search to calibrate the above intercepts for the `fall_run_model` function of the [fallRunDSM](https://github.com/CVPIA-OSC/fallRunDSM) R package.

Additionally, we are using [DSMCalibrationData](https://github.com/CVPIA-OSC/DSMCalibrationData) to access calibration related data.

**NEED TO BUILD DOCUMENTATION SITES FOR THESE AND UPDATE LINKS**

## Calibrating Data

### GrandTab

We will be minimizing the error between [GrandTab](https://wildlife.ca.gov/Conservation/Fishes/Chinook-Salmon/Anadromous-Assessment) estimated escapement data for the years 1998-2017 to natural spawners predicted by the DSM. Given that
GrandTab includes both hatchery and natural spawners, we will scale GrandTab escapement
values using the predicted proportion natural spawners for a given year generated by the model.
This will allow us to compare predicted natural spawners to psuedo GrandTab natural spawners.

**NEED TO MOVE IMPUTED AND OBSERVED GRANDTAB DATA AND CONFIRM WE HAVE BEST AVAILABLE**

For calibration, we have prepared the GrandTab data in two ways:

1. `DSMCalibrationData::grandtab_observed` - This data will be used in the fitness function to measure the difference between model predictions and observed escapement. Missing values are NA and we made all records less than 100 NA to account for a lack of confidence for counts less than 100. 

2. `DSMCalibrationData::grandtab_imputed` - This data will be used to calculate the number of juveniles during the 20 year simulation. The GrandTab data is incomplete for many watersheds during the 20 year period of calibration. For watersheds with no GrandTab data, we used 40 as the default escapement value. For watersheds with incomplete data, we used the mean escapement value. 

```{r}
grandtab_observed
```

```{r}
grandtab_imputed
```

### Selected Proxy Years

The data inputs to the DSM are for years 1980-1999. We selected proxy years for 1998-2017
from the 1980-1999 model inputs by [comparing the DWR water year indices](https://cdec.water.ca.gov/reportapp/javareports?name=WSIHIST) in this [analysis](https://github.com/CVPIA-OSC/DSMCalibrationData/blob/main/data-raw/synthetic_years.R).
These inputs are stored in the [DSMCalibrationData](https://github.com/CVPIA-OSC/DSMCalibrationData)
R package.

```{r echo=FALSE}
tibble::tibble(
  `Calibration Year` = names(DSMCalibrationData::calibration_year_lookup), 
  `Selected Proxy Year` = DSMCalibrationData::calibration_year_lookup) %>% 
  knitr::kable()
```


## Fitness Function

Sum of squared errors of simulated natural adults and grandtab adults scaled using 
simualted proportion natural, normalized by mean escapement. The purpose of normalizing is
to prevent watersheds with large escapement values from dominating the calibration.

All intercepts that need calibration are described in the Objective section of this document.
Note, `..surv_adult_enroute_int` and `..ocean_entry_success_int` are vectors and expanded within the fitness function arguments.

```{r}
fall_run_fitness <- function(
  known_adults = DSMCalibrationData::grandtab_observed,
  seeds = DSMCalibrationData::grandtab_imputed,
  surv_adult_enroute,
  surv_adult_prespawn,
  surv_egg_to_fry,
  uppermidsactribs_surv_juv,
  bypass_surv_juv,
  upsac_surv_juv,
  butte_surv_juv,
  deer_surv_juv,
  mill_surv_juv,
  sac_surv_juv,
  bear_surv_juv,
  feather_surv_juv,
  yuba_surv_juv,
  american_surv_juv,
  deltatribs_surv_juv,
  moke_surv_juv,
  merced_surv_juv,
  stan_surv_juv,
  tuol_surv_juv,
  sj_surv_juv, 
  surv_juv_rear_contact_points,
  surv_juv_rear_prop_diversions,
  surv_juv_rear_total_diversions,
  surv_juv_bypass_int,
  surv_juv_delta_int,
  surv_juv_delta_contact_points,
  surv_juv_delta_total_diverted,
  surv_juv_outmigration_sj_int,
  surv_juv_outmigration_sac_int_one,
  surv_juv_outmigration_sac_prop_diversions,
  surv_juv_outmigration_sac_total_diversions,
  surv_juv_outmigration_sac_int_two,
  default_ocean_entry_surv,
  upsac_ocean_entry_surv,
  butte_ocean_entry_surv,
  deer_ocean_entry_surv,
  mill_ocean_entry_surv,
  midsactribs_ocean_entry_surv,
  yuba_ocean_entry_surv,
  american_ocean_entry_surv,
  deltatribs_ocean_entry_surv,
  moke_ocean_entry_surv,
  merced_ocean_entry_surv,
  stan_ocean_entry_surv,
  tuol_ocean_entry_surv) {
  
  params <- list(
    ..surv_adult_enroute_int = surv_adult_enroute,
    ..surv_adult_prespawn_int = surv_adult_prespawn,
    ..surv_egg_to_fry_int = surv_egg_to_fry,
    ..surv_juv_rear_int = c(`Upper Sacramento River` = upsac_surv_juv, 
                            `Antelope Creek` = uppermidsactribs_surv_juv,
                            `Battle Creek` = uppermidsactribs_surv_juv,
                            `Bear Creek` = uppermidsactribs_surv_juv, 
                            `Big Chico Creek` = uppermidsactribs_surv_juv, 
                            `Butte Creek` = butte_surv_juv,
                            `Clear Creek` = uppermidsactribs_surv_juv, 
                            `Cottonwood Creek` = uppermidsactribs_surv_juv, 
                            `Cow Creek` = uppermidsactribs_surv_juv,
                            `Deer Creek` = deer_surv_juv, 
                            `Elder Creek` = uppermidsactribs_surv_juv, 
                            `Mill Creek` = mill_surv_juv,
                            `Paynes Creek` = uppermidsactribs_surv_juv, 
                            `Stony Creek` = uppermidsactribs_surv_juv, 
                            `Thomes Creek` = uppermidsactribs_surv_juv,
                            `Upper-mid Sacramento River` = sac_surv_juv, 
                            `Sutter Bypass` = bypass_surv_juv,
                            `Bear River` = uppermidsactribs_surv_juv, 
                            `Feather River` = uppermidsactribs_surv_juv, 
                            `Yuba River` = yuba_surv_juv,
                            `Lower-mid Sacramento River` = sac_surv_juv,
                            `Yolo Bypass` = bypass_surv_juv, 
                            `American River` = american_surv_juv,
                            `Lower Sacramento River` = sac_surv_juv, 
                            `Calaveras River` = deltatribs_surv_juv, 
                            `Cosumnes River` = deltatribs_surv_juv,
                            `Mokelumne River` = moke_surv_juv, 
                            `Merced River` = merced_surv_juv, 
                            `Stanislaus River` = stan_surv_juv,
                            `Tuolumne River` = tuol_surv_juv, 
                            `San Joaquin River` = sj_surv_juv),
    ..surv_juv_rear_contact_points = surv_juv_rear_contact_points,
    ..surv_juv_rear_prop_diversions = surv_juv_rear_prop_diversions,
    ..surv_juv_rear_total_diversions = surv_juv_rear_total_diversions,
    ..surv_juv_bypass_int = surv_juv_bypass_int,
    ..surv_juv_delta_int = surv_juv_delta_int,
    ..surv_juv_delta_contact_points = surv_juv_delta_contact_points,
    ..surv_juv_delta_total_diverted = surv_juv_delta_total_diverted,
    ..surv_juv_outmigration_sj_int = surv_juv_outmigration_sj_int,
    ..surv_juv_outmigration_sac_int_one = surv_juv_outmigration_sac_int_one,
    ..surv_juv_outmigration_sac_prop_diversions = surv_juv_outmigration_sac_prop_diversions,
    ..surv_juv_outmigration_sac_total_diversions = surv_juv_outmigration_sac_total_diversions,
    ..surv_juv_outmigration_sac_int_two = surv_juv_outmigration_sac_int_two,
    ..ocean_entry_success_int = c(
      `Upper Sacramento River` = upsac_ocean_entry_surv,
      `Antelope Creek` = default_ocean_entry_surv,
      `Battle Creek` = default_ocean_entry_surv,
      `Bear Creek` = default_ocean_entry_surv,
      `Big Chico Creek` = default_ocean_entry_surv,
      `Butte Creek` = butte_ocean_entry_surv,
      `Clear Creek` = default_ocean_entry_surv,
      `Cottonwood Creek` = default_ocean_entry_surv,
      `Cow Creek` = default_ocean_entry_surv,
      `Deer Creek` = deer_ocean_entry_surv,
      `Elder Creek` = default_ocean_entry_surv,
      `Mill Creek` = mill_ocean_entry_surv,
      `Paynes Creek` = default_ocean_entry_surv,
      `Stony Creek` = default_ocean_entry_surv,
      `Thomes Creek` = default_ocean_entry_surv,
      `Upper-mid Sacramento River` = default_ocean_entry_surv,
      `Sutter Bypass` = default_ocean_entry_surv,
      `Bear River` = midsactribs_ocean_entry_surv,
      `Feather River` = midsactribs_ocean_entry_surv,
      `Yuba River` = yuba_ocean_entry_surv,
      `Lower-mid Sacramento River` = default_ocean_entry_surv,
      `Yolo Bypass` = default_ocean_entry_surv,
      `American River` = american_ocean_entry_surv,
      `Lower Sacramento River` = default_ocean_entry_surv,
      `Calaveras River` = deltatribs_ocean_entry_surv,
      `Cosumnes River` = deltatribs_ocean_entry_surv,
      `Mokelumne River` = moke_ocean_entry_surv,
      `Merced River` = merced_ocean_entry_surv,
      `Stanislaus River` = stan_ocean_entry_surv,
      `Tuolumne River` = tuol_ocean_entry_surv,
      `San Joaquin River` = default_ocean_entry_surv)
  )
  
  
  preds <- fall_run_model(mode = "calibrate", 
                          seeds = seeds,
                          ..params = params)
  
  sum(((preds$natural_adults - (known_adults * preds$proportion_natural)) / 
         rowMeans(known_adults, na.rm = TRUE)) ^ 2, na.rm = TRUE)
}
```


```{r, eval=FALSE}


list2env(load_baseline_data(), .GlobalEnv)

fr_seeds <- fall_run_model(mode = "seed")
fr_calib 
# calibration method: random uniform
res <- fall_run_fitness(seeds = fr, 
                        -1.58237238018773, 0.69242465053685, 0.547911047004163, 3.24953947332688, 
                        -2.60139458812773, -1.77459052228369, 1.37481784983538, 1.81681571574882, 
                        -1.89281405741349, -2.10046693566255, 0.959760472178459, 0.29393222508952, 
                        -1.42802732321434, -2.04492410412058, 3.02062905975617, -2.02917007915676, 
                        -1.0894597757142, -3.25650308071636, -0.356537831714377, 1.14620552933775, 
                        -3.06538275070488, -0.125882726162672, -1.00182074634358, 0.419130359077826, 
                        0.130164961097762, -0.275444792583585, 2.57036253204569, -0.348846448585391, 
                        -2.99958411906846, 3.05890744552016, 3.40577717358246, -0.612491697072983, 
                        1.325736960629, -3.13401527120732, 1.44230719725601, -1.63610807503574, 
                        -0.286132822744548, 1.87164844037034, 3.1336920496542, 1.99737431155518, 
                        1.16786763840355, -0.680227355100214, 1.82930355984718, 2.98046222748235, 
                        1.58190411003307)

```















