---
title: "Calibrating Fall Run DSM"
output: html_notebook
---

## Objective

We are using genetic algorithms, a type of stochastic optimization, to calibrate the following model coefficients:

* `..surv_adult_enroute_int`
* `..surv_adult_prespawn_int`
* `..surv_egg_to_fry_int`
* `..surv_juv_rear_int`
* `..surv_juv_rear_contact_points`
* `..surv_juv_rear_prop_diversions`
* `..surv_juv_rear_total_diversions`
* `..surv_juv_bypass_int`
* `..surv_juv_delta_int`
* `..surv_juv_delta_contact_points`
* `..surv_juv_delta_total_diverted`
* `..surv_juv_outmigration_sj_int`
* `..surv_juv_outmigration_sac_int_one`
* `..surv_juv_outmigration_sac_prop_diversions`
* `..surv_juv_outmigration_sac_total_diversions`
* `..surv_juv_outmigration_sac_int_two`
* `..ocean_entry_success_int`


## Packages
```{r}
library(GA)
library(fallRunDSMCalibration)
library(DSMCalibrationData)
library(tidyverse)
```
We are using the [GA](http://luca-scr.github.io/GA/index.html) R package to implement our genetic algorithms search
and the [fallRunDSMCalibration](https://github.com/CVPIA-OSC/fallRunDSMCalibration) R package that contains
a version of [fallRunDSM](https://github.com/CVPIA-OSC/fallRunDSM) that has exposed the above model coefficients
in the `fall_run_model` function to enable optimization of these coefficients.
Additionally, we are using [DSMCalibrationData](https://github.com/CVPIA-OSC/DSMCalibrationData) to access calibration
related data.

**NEED TO BUILD DOCUMENTATION SITES FOR THESE AND UPDATE LINKS**


## Calibrating Data
We will be minimizing the error between [GrandTab](https://wildlife.ca.gov/Conservation/Fishes/Chinook-Salmon/Anadromous-Assessment) estimated escapement data for the years 1998-2017 and escapement predicted by the DSM. The data inputs to the DSM are for years 1980-1999. We selected proxy years for 1998-2017
from the 1980-1999 model inputs by [comparing the DWR water year indices](https://cdec.water.ca.gov/reportapp/javareports?name=WSIHIST) in this [analysis](https://github.com/CVPIA-OSC/DSMCalibrationData/blob/main/data-raw/synthetic_years.R).

### Selected Proxy Years
```{r echo=FALSE}
tibble::tibble(
  `Calibration Year` = names(DSMCalibrationData::calibration_year_lookup), 
  `Selected Proxy Year` = DSMCalibrationData::calibration_year_lookup) 
```

### GrandTab Data

The watersheds for which are comparing to grand tab data are:

```{r warning=FALSE, message=FALSE}
adults_to_calibrate <- read_csv("data-raw/fall-run-calibration/knownAdults_1998_2016.csv")
watershed_to_calibrate <- adults_to_calibrate %>% 
  filter(!is.na(seed))
```

display table of data

```{r}

```


## Fitness Function

The fitness function used during the 2019 calibration was a total sum of squares error computed from the predicted 
and known values for each of the watersheds above. In addition to this, extra penalizing terms in the form of total 
correlation between predicted and known was added. This correlation portion is a little unclear as to what its purpose
is within the fitness function since minimizing correlation as a penalty will create negative correlation or worse 0 
correlation.

The fitness function used with the GA function must expose the values we are seeking to optimize as function 
arguments.

```{r}
fit_rear_surv <- function(
  surv_adult_enroute,
  surv_adult_prespawn,
  surv_egg_to_fry,
  uppermidsactribs_surv_juv,
  bypass_surv_juv,
  upsac_surv_juv,
  butte_surv_juv,
  deer_surv_juv,
  mill_surv_juv,
  sac_surv_juv,
  bear_surv_juv,
  feather_surv_juv,
  yuba_surv_juv,
  american_surv_juv,
  deltatribs_surv_juv,
  moke_surv_juv,
  merced_surv_juv,
  stan_surv_juv,
  tuol_surv_juv,
  sj_surv_juv) {

  
  params <- list(
  ..surv_adult_enroute_int = surv_adult_enroute,
  ..surv_adult_prespawn_int = surv_adult_prespawn,
  ..surv_egg_to_fry_int = surv_egg_to_fry,
  ..surv_juv_rear_int = c(`Upper Sacramento River` = upsac_surv_juv, 
                          `Antelope Creek` = uppermidsactribs_surv_juv,
                          `Battle Creek` = uppermidsactribs_surv_juv,
                          `Bear Creek` = uppermidsactribs_surv_juv, 
                          `Big Chico Creek` = uppermidsactribs_surv_juv, 
                          `Butte Creek` = butte_surv_juv,
                          `Clear Creek` = uppermidsactribs_surv_juv, 
                          `Cottonwood Creek` = uppermidsactribs_surv_juv, 
                          `Cow Creek` = uppermidsactribs_surv_juv,
                          `Deer Creek` = deer_surv_juv, 
                          `Elder Creek` = uppermidsactribs_surv_juv, 
                          `Mill Creek` = mill_surv_juv,
                          `Paynes Creek` = uppermidsactribs_surv_juv, 
                          `Stony Creek` = uppermidsactribs_surv_juv, 
                          `Thomes Creek` = uppermidsactribs_surv_juv,
                          `Upper-mid Sacramento River` = sac_surv_juv, 
                          `Sutter Bypass` = bypass_surv_juv,
                          `Bear River` = uppermidsactribs_surv_juv, 
                          `Feather River` = uppermidsactribs_surv_juv, 
                          `Yuba River` = yuba_surv_juv,
                          `Lower-mid Sacramento River` = sac_surv_juv,
                          `Yolo Bypass` = bypass_surv_juv, 
                          `American River` = american_surv_juv,
                          `Lower Sacramento River` = sac_surv_juv, 
                          `Calaveras River` = deltatribs_surv_juv, 
                          `Cosumnes River` = deltatribs_surv_juv,
                          `Mokelumne River` = moke_surv_juv, 
                          `Merced River` = merced_surv_juv, 
                          `Stanislaus River` = stan_surv_juv,
                          `Tuolumne River` = tuol_surv_juv, 
                          `San Joaquin River` = sj_surv_juv),
  ..surv_juv_rear_contact_points = -0.0068,
  ..surv_juv_rear_prop_diversions = -0.1755,
  ..surv_juv_rear_total_diversions = -0.0005,
  ..surv_juv_bypass_int = -3.5,
  ..surv_juv_delta_int = 1.4,
  ..surv_juv_delta_contact_points = (.0358 * -0.189),
  ..surv_juv_delta_total_diverted = (.5 * -0.0021),
  ..surv_juv_outmigration_sj_int = -3.5,
  ..surv_juv_outmigration_sac_int_one = 2.5,
  ..surv_juv_outmigration_sac_prop_diversions = (-3.51 * .05),
  ..surv_juv_outmigration_sac_total_diversions = (-.0021 * .215),
  ..surv_juv_outmigration_sac_int_two = 0.3,
  ..ocean_entry_success_int = c(
    `Upper Sacramento River` = -0.5108849,
    `Antelope Creek` = 1.2,
    `Battle Creek` = 1.2,
    `Bear Creek` = 1.2,
    `Big Chico Creek` = 1.2,
    `Butte Creek` = -3.3233638,
    `Clear Creek` = 1.2,
    `Cottonwood Creek` = 1.2,
    `Cow Creek` = 1.2,
    `Deer Creek` = -3.2304288,
    `Elder Creek` = 1.2,
    `Mill Creek` = -3.4148335,
    `Paynes Creek` = 1.2,
    `Stony Creek` = 1.2,
    `Thomes Creek` = 1.2,
    `Upper-mid Sacramento River` = 1.2,
    `Sutter Bypass` = 1.2,
    `Bear River` = -3.5,
    `Feather River` = -3.5,
    `Yuba River` = -3.5,
    `Lower-mid Sacramento River` = 1.2,
    `Yolo Bypass` = 1.2,
    `American River` = -1.308341,
    `Lower Sacramento River` = 1.2,
    `Calaveras River` = -1.9841364,
    `Cosumnes River` = -1.9841364,
    `Mokelumne River` = 2.5000007,
    `Merced River` = -3.5,
    `Stanislaus River` = -3,
    `Tuolumne River` = -0.9,
    `San Joaquin River` = 1.2)
)


  preds <- fall_run_model(seeds = fr_seeds,
                          ..params = param_list)

  # norm_base <- row_normalize(base_run$spawners[ws, , drop = FALSE])
  # norm_preds <- row_normalize(preds$spawners[ws, , drop = FALSE])
  # sum((norm_base - norm_preds)^2)
  sum(((spawners$natural_adults - (known_adults * spawners$proportion_natural))/rowMean(known_adults))^2)
}


 list(init_adults = init_adults,
       proportion_natural = replace(proportion_natural, is.nan(proportion_natural), NA_real_),
       natural_adults = surviving_natural_adults,
       init_adults_by_month = init_adults_by_month)



```
















